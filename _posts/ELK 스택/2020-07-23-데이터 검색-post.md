---
title: "데이터 검색"
date: 2020-07-23 15:44:00 -0400
categories: ELK스택
---

## 검색 질의 표현 방식

### URL 검색

-   HTTP GET 요청을 활용하는 방식으로 파라미터를 'Key=Value' 형태로 전달하는 방식
-   URL에 검색할 칼럼과 검색어를 직접 지정하면 검색이 수행됨
-   파라미터로 표현할 수 있는 표현의 한계로 복잡한 질의를 작성하는 것은 불가능
-   ES에서 제공하는 모든 검색 옵션을 사용할 수 없음

### Requset Body 검색

-   HTTP 요청 시 Body에 검색할 칼럼과 검색어를 JSON 형태로 표현해서 전달하는 방식
-   JSON 형태의 표현을 좀 더 효율적으로 하기 위해 엘라스틱서치에서는 Query DSL이라는 특별한 문법을 지원
-   이를 이용하면 URI 방식에 비해 다양한 조합의 검색 쿼리를 작성할 수 있음
-   ES가 제공하는 검색 API를 모두 활용하기 위해서는 반드시 Request Body 방식을 이용해야 함

## Query DSL

### 검색 질의를 요청할 때는 Request Body 검색과 URI 검색 모두 \_search API를 이용해 검색 질의 함

### Query DSL 쿼리와 필터

| `구분` | `쿼리 컨텍스트`                                                                                                                                                                                                            | `필터 컨텍스트`                                                                                                                                                                                                               |
| :----: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|  용도  | 전문 검색 시 사용                                                                                                                                                                                                          | 조건 검색시 사용(예: Yes/No)                                                                                                                                                                                                  |
|  특징  | 문서가 쿼리와 얼마나 유사한지를 스코어로 계산<br>질의가 요청될 때마다 엘라스틱서치에서 내부의 루씬을 이용해 계산을 수행<br>일반적으로 전문 검색에 많이 사용<br>캐싱되지 않고 디스크 연산을 수행하기 때문에 상대적으로 빠름 | 쿼리의 조건과 문서가 일치하는(Yes/No)를 구분<br>별도로 스코어를 계산하지 않고 단순 매칭 여부를 검사<br>자주 사용되는 필터의 결과는 엘라스틱서치가 내부적으로 캐싱<br>기본적으로 메모리 연산을 수행하기 때문에 상대적으로 빠름 |
| 사용예 | "Harry Potter" 같은 문장 분석                                                                                                                                                                                              | "create_year" 필드의 값이 2018년인지 여부<br>"status" 필드에 'user'라는 코드 포함 여부                                                                                                                                        |

### Query DSL 쿼리의 구조

-   Query DSL 요청 JSON 구조

```
{
    "size":             --리턴받는 결과의 개수를 지정. 기본값 10
    "from":             --몇 번째 문서부터 가져올지를 지정. 기본값은 0
    "timeout":          --검색을 요청해서 결과를 받는 데까지 걸리는 시간. 기본값은 무한대
    "_source": { }      --검색 시 필요한 필드만 출력하고 싶을 때 사용
    "query": { }        --검색 조건문이 들어가야 하는 공간
    "aggs": { }         --통계 및 집계 데이터를 사용할 때 사용하는 공간
    "sort": { }         --문서 결과를 어떻게 출력할지에 대한 조건을 사용하는 공간
}
```

-   Query DSL 응답 구조

```
{
    "took":              --쿼리를 실행한 시간을 나타냄
    "time_out":          --쿼리 시간이 초과할 경우를 나타냄
    "shards": {
        "total":         --쿼리를 요청한 전체 샤드의 개수를 나타냄
        "successful":    --검색 요청에 성공적으로 응답한 샤드의 개수를 나타냄
        "failed":        --검색 요청에 실패한 샤드의 개수를 나타냄
    },
    "hits": {
        "total":         --검색어에 매칭된 문서의 전체 개수를 나타냄
        "max_score":     --일치하는 문서의 스코어 값 중 가장 높은 값을 출력
        "hits": [ ]      --각 문서 정보와 스코어 값을 보여줌
    }
}
```

### Query DSL의 주요 파라미터

#### 1. Multi Index 검색

-   기본적으로 모든 검색 요청은 Multi Index 및 Multi Type 검색이 가능함

#### 2. 쿼리 결과 페이징

-   문서의 시작을 나타내기 위해 from 파라미터를 사용(기본값 : 0)
-   문서의 개수를 나타내기 위해 size 파라미터를 사용(기본값 : 5)3) 쿼리 결과 정렬

#### 3. \_source 필드 필터링

-   검색 요청시 \_source에 검색 결과를 포함하고 싶은 필드를 지정해서 특정 컬럼만 결과로 받음

#### 4. 범위 검색

| `문법` | `연산자` | `설명`                   |
| :----: | :------: | :----------------------- |
|   lt   |    <     | 피연산자보다 적음        |
|   gt   |    >     | 피연사자보다 큼          |
|  lte   |    <=    | 피연산자보다 작거나 같음 |
|  gte   |    <=    | 피연산자보다 크거나 같음 |

#### 5. operator 설정

-   ES는 검색 시 문장이 들어올 경우 기본적으로 OR 연산으로 동작
-   명시적으로 AND 연산을 사용해야할 경우 사용

#### 6. minimum_should_match 설정

-   문서의 결과에 포함할 텀의 최소 개수를 지정

#### 7. fuzziness 설정

-   관련성이 높은 필드나 키워드에 가중치를 더 줄 수 있게 함

## Query DSL의 주요쿼리

#### 1. Match All Query

-   match_all 파라미터를 사용하는 모든 문서를 검색하는 쿼리

#### 2. Match Query

-   텍스트, 숫자, 날짜 등이 포함된 문장을 형태소 분석을 통해 텀으로 분리한 후 이 텀들을 이용해 검색 질의를 수행

#### 3. Multi Match Query

-   multi_match 파라미터를 이용

#### 4. Term Query

-   텍스트 형태의 값을 검색하기 위해 Text, Keyword 데이터 타입을 지원

#### 5. Bool Query

-   관계형 데이터베이스에서는 AND, OR로 묶은 여러 조건을 where 절에서 사용할 수 있는것 처럼 ES에서도 여러개의 쿼리를 조합해 사용

#### 6. Query String

-   기존 텀 쿼리와 다르게 공백은 연산자로 사용되지 않으며 입력된 텍스트 그대로 형태소 분석기에 전달

#### 7. Prefix Qeury

-   해당 접두어가 있는 모든 문서를 검색하는 데 사용

#### 8. Exists Query

-   생성하지 않은 필드타, null 데이터를 제외하고 실제 값이 존재하는 문서만 찾을때 사용

#### 9. Wildcard Query

-   검색어가 와일드카드와 일치하는 구문을 찾음(이때 입력된 검색어는 형태소 분석이 이뤄지지 않음)

#### 10. Nested Query

-   ES는 분산 데이터 환경에서도 SQL 조인과 유사한 기능을 수행하는 Nested Query를 제공
